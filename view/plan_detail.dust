<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Arise Admin Panel" />
    <meta name="keywords" content="Admin, Dashboard, Bootstrap3, Sass, transform, CSS3, HTML5, Web design, UI Design, Responsive Dashboard, Responsive Admin, Admin Theme, Best Admin UI, Bootstrap Theme, Themeforest, Bootstrap, C3 Graphs, D3 Graphs, NVD3 Graphs, Admin Skin, Black Admin Dashboard, Grey Admin Dashboard, Dark Admin Dashboard, Simple Admin Dashboard, Simple Admin Theme, Simple Bootstrap Dashboard, " />
    <meta name="author" content="dongyt" />
    <title>高尔夫球场中控管理系统</title>

    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />

    <!-- Main CSS -->
    <link href="css/main.css" rel="stylesheet" media="screen" />

    <!-- Ion Icons -->
    <link href="fonts/font-awesome.css" rel="stylesheet" />

    <!-- Ion Icons -->
    <link href="fonts/icomoon/icomoon.css" rel="stylesheet" />

    <!-- Alertify CSS -->
    <link href="css/alertify/core.css" rel="stylesheet"/>
    <link href="css/alertify/default.css" rel="stylesheet"/>

    <link href="css/metroStyle/metroStyle.css" rel="stylesheet" type="text/css"/>

    <!-- HTML5 shiv and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">
        .dongtq {
            cursor: pointer;
            font-size: 13px;
            border: 1px solid #2a76f6;
            margin-left: 2px;
            padding: 0 1px;
            width: 20px;
            text-align: center;
            vertical-align: top;
            *vertical-align: middle
        }
        .dongtq:hover {
            color: white;
            background-color: #2a76f6;
        }
        .gaofen {
            color: white;
            background-color: #2a76f6;
        }
        input::-webkit-input-placeholder {
            color: rgba(102, 102, 102, 0.6);
        }
        input:-moz-placeholder {
            color: rgba(102, 102, 102, 0.6);
        }
        input:-ms-input-placeholder {
            color: rgba(102, 102, 102, 0.6);
        }
    </style>
</head>

<body>

<!-- 定义这两个button不会报错了 -->
<button class="collapse-menu" style="display: none;"></button>
<button type="button" id="toggleMenu" class="toggle-menu" style="display: none;"></button>

<div class="row gutter">
    <div class="col-lg-7 col-md-12 col-sm-12 col-xs-12">
        <div class="panel" style="overflow: auto;">
            <ul id="nozzletree" class="ztree"></ul>
        </div>
    </div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/jquery.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>

<!-- jquery ScrollUp JS -->
<script src="js/scrollup/jquery.scrollUp.js"></script>

<!-- Notifications JS -->
<script src="js/alertify/alertify.js"></script>
<script src="js/alertify/alertify-custom.js"></script>

<!-- Custom JS -->
<script src="js/custom.js"></script>

<script type="text/javascript" src="js/ztree/jquery.ztree.core.min.js"></script>
<script type="text/javascript" src="js/ztree/jquery.ztree.exedit.min.js"></script>
<script type="text/javascript" src="js/ztree/jquery.ztree.excheck.min.js"></script>

<script type="text/javascript">
    var setting = {
        check: {
            enable: true
        },
        view: {
            addDiyDom: addDiyDom,
            selectedMulti: false
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "parent_id",
                rootPId: 0
            }
        },
        edit: {
            enable: false,
            showRemoveBtn: showRemoveBtn,
            showRenameBtn: showRenameBtn
        },
        callback: {
            beforeCollapse: beforeCollapse,
            beforeExpand: beforeExpand
        }
    };

    var nozzleNodes = [{#nozzleNodes}{@eq key=$idx value=0 type="number"}
        {id:"{id}",parent_id:"{parent_id}",name:"{name}",open:false,icon:"{icon}",iconOpen:"{icon}",iconClose:"{icon}"}{:else},
        {id:"{id}",parent_id:"{parent_id}",name:"{name}",open:false,icon:"{icon}",iconOpen:"{icon}",iconClose:"{icon}"}{/eq}{/nozzleNodes}
    ];

    var dates = [{#dates}{@eq key=$idx value=0 type="number"}
        "{.}"{:else},
        "{.}"{/eq}{/dates}
    ];

    function addDiyDom(treeId, treeNode) {
        if (!treeNode.parent_id) {
            var sObj = $("#" + treeNode.tId + "_a");
            var addStr = "<span style='font-size: 13px; font-family: 微软雅黑;' id='date_" + treeNode.id + "'>&nbsp;&nbsp;运行日: {#days}<span id='date_" + treeNode.id + "_" + dates[{$idx}] + "' class='dongtq' title='选日期' onclick='$(this).toggleClass(\"gaofen\")' data-date='{$idx}'>{.}</span>{/days}</span><span style='font-size: 13px; font-family: 微软雅黑;'>&nbsp;&nbsp;开始时间: <input style='width: 30px; height: 18px; text-align: center; font-size: 13px; border: 1px solid #000;' id='start_hour_" + treeNode.id  + "' placeholder='00'/>点<input style='width: 30px; height: 18px; text-align: center; font-size: 13px; border: 1px solid #000;' id='start_minute_" + treeNode.id  + "' placeholder='00'/>分</span><span style='font-size: 13px; font-family: 微软雅黑;'>&nbsp;&nbsp;灌溉时长: <input style='width: 30px; height: 18px;text-align: center; font-size: 13px; border: 1px solid #000;' id='howlong_hour_" + treeNode.id  + "' placeholder='0'/>小时<input style='width: 30px; height: 18px; text-align: center; font-size: 13px; border: 1px solid #000;' id='howlong_minute_" + treeNode.id  + "' placeholder='0'/>分钟</span> <button onclick='save(" + treeNode.id + ")' class='btn btn-success btn-rounded' type='button' style='padding: 0 8px; font-size: 13px; font-family: 微软雅黑;'>保存计划</button>";
            sObj.after(addStr);
        }
    }

    function save(area_id) {
        var a = $("#date_" + area_id).children(".gaofen");
        if (a.length === 0) {
            alertify.error("请选择运行日");
            return;
        }
        if ($("#start_hour_" + area_id).val() === '') {
            alertify.error("开始时间不能为空");
            return;
        }
        if ($("#start_minute_" + area_id).val() === '') {
            alertify.error("开始时间不能为空");
            return;
        }
        if ($("#howlong_hour_" + area_id).val() === '') {
            alertify.error("灌溉时长不能为空");
            return;
        }
        if ($("#howlong_minute_" + area_id).val() === '') {
            alertify.error("灌溉时长不能为空");
            return;
        }
        var strDate = "";
        for(var i=0; i<a.length; i++) {
            strDate += dates[$(a[i]).data('date')] + ",";
        }
        if (strDate.length > 0) {
            strDate = strDate.substr(0, strDate.length - 1);
        }
        var nodes = $.fn.zTree.getZTreeObj("nozzletree").getNodesByFilter(function(node) {
            var s = "" + node.parent_id;
            return s.indexOf(area_id + "-") >= 0;
        });
        var nozzle_ids = "";
        for(var index=0; index<nodes.length; index++) {
            if (nodes[index].checked) {
                nozzle_ids += nodes[index].id.slice(1) + ",";
            }
        }
        if (nozzle_ids.length > 0) {
            nozzle_ids = nozzle_ids.substr(0, nozzle_ids.length - 1);
        } else {
            alertify.error("请选择洒水站");
            return;
        }
        $.post("/save_plan.do", {
            course_id: $("#course", window.parent.document).val(),
            area_id: area_id,
            cover_date: strDate,
            start_time: $("#start_hour_" + area_id).val() + ":" + $("#start_minute_" + area_id).val(),
            hour: $("#howlong_hour_" + area_id).val(),
            minute: $("#howlong_minute_" + area_id).val(),
            involved_nozzle: nozzle_ids
        }, function (result) {
            if (result.success) {
                location.reload(true);
            }
        });
    }

    function showRemoveBtn(treeId, treeNode) {
        return false;
    }

    function showRenameBtn(treeId, treeNode) {
        return false;
    }

    function beforeCollapse(event, treeId, treeNode) {
        reinitIframe();
    }

    function beforeExpand(event, treeId, treeNode) {
        reinitIframe();
    }

    var selected_nozzle_id = "";
    function click_selected_nozzle(nozzle_id) {
        selected_nozzle_id = nozzle_id;
    }

    jQuery(function ($) {
        $.fn.zTree.init($("#nozzletree"), setting, nozzleNodes);
{#area_init_values}
{#cover_dates}
        $("#date_{area_id}_{.}").toggleClass("gaofen");
{/cover_dates}
        $("#start_hour_{area_id}").val({start_hour});
        $("#start_minute_{area_id}").val({start_minute});
        $("#howlong_hour_{area_id}").val({howlong_hour});
        $("#howlong_minute_{area_id}").val({howlong_minute});
{#involved_nozzle}
        $.fn.zTree.getZTreeObj("nozzletree").checkNode($.fn.zTree.getZTreeObj("nozzletree").getNodeByParam("id", "t{.}"), true, true, false);
{/involved_nozzle}
{/area_init_values}
        reinitIframe();
    });

    window.onresize = function () {
        reinitIframe();
    };

    function reinitIframe() {
        setTimeout("parent.document.getElementById('myFrame').height = document.body.scrollHeight || document.documentElement.scrollHeight;", 100);
    }
</script>
</body>
</html>
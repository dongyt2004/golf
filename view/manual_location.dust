<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Arise Admin Panel" />
    <meta name="keywords" content="Admin, Dashboard, Bootstrap3, Sass, transform, CSS3, HTML5, Web design, UI Design, Responsive Dashboard, Responsive Admin, Admin Theme, Best Admin UI, Bootstrap Theme, Themeforest, Bootstrap, C3 Graphs, D3 Graphs, NVD3 Graphs, Admin Skin, Black Admin Dashboard, Grey Admin Dashboard, Dark Admin Dashboard, Simple Admin Dashboard, Simple Admin Theme, Simple Bootstrap Dashboard, " />
    <meta name="author" content="dongyt" />
    <title>高尔夫球场中控管理系统</title>

    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />

    <!-- Main CSS -->
    <link href="css/main.css" rel="stylesheet" media="screen" />

    <!-- Ion Icons -->
    <link href="fonts/font-awesome.css" rel="stylesheet" />

    <!-- Ion Icons -->
    <link href="fonts/icomoon/icomoon.css" rel="stylesheet" />

    <link href="css/metroStyle/metroStyle.css" rel="stylesheet" type="text/css"/>

    <!-- HTML5 shiv and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">
        .dongyt {
            margin-right: 10px;
        }
        .sunzhh{
        }
        @media(max-width:619px) {
            .dongyk {
                text-align: center;
            }
        }
        .BMapLabel{ max-width:none; }
    </style>
</head>

<body>

<!-- 定义这两个button不会报错了 -->
<button class="collapse-menu" style="display: none;"></button>
<button type="button" id="toggleMenu" class="toggle-menu" style="display: none;"></button>

<!-- Row starts -->
<div class="row gutter">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="panel dongyk">

            <a href="#" class="btn btn-success dongyt" id="send">发 送</a>

        </div>
    </div>
</div>
<!-- Row Ends -->

<div class="row gutter">
    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12">
        <div style="width:100%; height:700px; border:#ccc solid 1px; display: none;" id="map"></div>
    </div>

    <div class="col-lg-2 col-md-12 col-sm-12 col-xs-12">
        <div class="panel">
            <div class="panel-heading">
                <h4>待选洒水站</h4>
            </div>
            <ul id="nozzletree" class="ztree"></ul>
        </div>
    </div>

    <div class="col-lg-2 col-md-12 col-sm-12 col-xs-12">
        <div class="panel center-text">

            <a href="#" class="btn btn-info dongyt" id="to_tree"><i class="icon-chevron-left"></i> </a>
            <a href="#" class="btn btn-info dongyt" id="to_list"><i class="icon-chevron-right"></i> </a>

        </div>
    </div>

    <div class="col-lg-2 col-md-12 col-sm-12 col-xs-12 sunzhh">
        <div class="panel">
            <div class="panel-heading">
                <h4>选中的洒水站</h4>
            </div>
            <div class="list-group no-margin" id="selected_nozzle">
            </div>
        </div>
    </div>
</div>

<div class="modal" id="loadingModal" data-backdrop="static" data-keyboard="false">
    <div style="width: 200px;height:20px; z-index: 20000; position: absolute; text-align: center; left: 50%; top: 50%; margin-left:-100px; margin-top:-10px">
        <div class="progress progress-striped active" style="margin-bottom: 0;">
            <div class="progress-bar" style="width: 100%;"></div>
        </div>
        <h5 style="color:white"> <strong>正在获取经纬度，请稍等...</strong> </h5>
    </div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/jquery.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>

<!-- jquery ScrollUp JS -->
<script src="js/scrollup/jquery.scrollUp.js"></script>

<!-- Custom JS -->
<script src="js/custom.js"></script>

<script type="text/javascript" src="js/ztree/jquery.ztree.core.min.js"></script>
<script type="text/javascript" src="js/ztree/jquery.ztree.exedit.min.js"></script>
<script type="text/javascript" src="js/ztree/jquery.ztree.excheck.min.js"></script>
<script type="text/javascript" src="js/ztree/jquery.ztree.exhide.js"></script>

<!--引用百度地图API-->
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=jDFwTVOf78ilWOUthg3Pexm3RmCmSLRl"></script>
<script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/convertor.js"></script>

<script type="text/javascript">
    function initPosition(position) {
        BMap.Convertor.translate(new BMap.Point(position.coords.longitude, position.coords.latitude), 0, function (point) {
            location.replace('/manual_location.html?lon=' + point.lng + '&lat=' + point.lat);
        });
    }

    function error(err) {
        $('#loadingModal').modal('hide');
    }

    function getLocation() {
        if (navigator.geolocation) {
            $("#loadingModal").modal('show');
            navigator.geolocation.getCurrentPosition(initPosition, error, {
                /* 指示浏览器获取高精度的位置，默认为false */
                enableHighAccuracy: true,
                /* 指定获取地理位置的超时时间，默认不限时，单位为毫秒 */
                timeout: 10000,
                /* 最长有效期，在重复获取地理位置时，此参数指定多久再次获取位置。 */
                maximumAge: 20000
            });
        }
    }

    var setting = {
        check: {
            enable: true
        },
        view: {
            selectedMulti: false
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "parent_id",
                rootPId: 0
            }
        },
        edit: {
            enable: true,
            showRemoveBtn: showRemoveBtn,
            showRenameBtn: showRenameBtn
        },
        callback: {
            onDrop: onDrop,
            beforeDrag: beforeDrag,
            beforeDrop: beforeDrop,
            onCollapse: onCollapse,
            onExpand: onExpand
        }
    };

    var nozzleNodes = [{#nozzleNodes}{@eq key=$idx value=0 type="number"}
        {id:"{id}",parent_id:"{parent_id}",name:"{name}",open:true,icon:"{icon}",iconOpen:"{icon}",iconClose:"{icon}"}{:else},
        {id:"{id}",parent_id:"{parent_id}",name:"{name}",open:true,icon:"{icon}",iconOpen:"{icon}",iconClose:"{icon}"}{/eq}{/nozzleNodes}
    ];

    function showRemoveBtn(treeId, treeNode) {
        return false;
    }

    function showRenameBtn(treeId, treeNode) {
        return false;
    }

    function beforeDrag(treeId, treeNodes) {
        return treeNodes[0].id.substr(0, 1) === 't';
    }

    function beforeDrop(treeId, treeNodes, targetNode, moveType) {
        if (treeId === 'nozzletree') {
            return false;
        }
    }

    function onDrop(e, treeId, treeNodes, targetNode, moveType) {
        if (moveType === null && $(e.target).parents(".sunzhh").length > 0 && treeNodes[0].name.indexOf('[正在维修]') < 0 && treeNodes[0].name.indexOf('[正在洒水]') < 0) {
            $('#selected_nozzle').append('<a onclick="click_selected_nozzle(\'' + treeNodes[0].id + '\')" id="' + treeNodes[0].id + '" href="javascript:void(0)" class="list-group-item list-group-item-info" data-original-title="" title="" data-parent_id="' + treeNodes[0].parent_id + '" data-icon="' + treeNodes[0].icon + '">' + treeNodes[0].name + '</a>');
            $.fn.zTree.getZTreeObj("nozzletree").removeNode(treeNodes[0]);
            reinitIframe();
        }
    }

    function onCollapse(event, treeId, treeNode) {
        reinitIframe();
    }

    function onExpand(event, treeId, treeNode) {
        reinitIframe();
    }

    var selected_nozzle_id = "";
    function click_selected_nozzle(nozzle_id) {
        selected_nozzle_id = nozzle_id;
    }

    jQuery(function ($) {
        $('#loadingModal').modal('hide');

{@eq key=lon value=""}
        getLocation();
{/eq}

        $.fn.zTree.init($("#nozzletree"), setting, nozzleNodes);

        $("#to_list").click(function() {
            var nozzleNodes = [];
            var srcNodes = $.fn.zTree.getZTreeObj("nozzletree").getCheckedNodes(true);
            for (var i=0; i<srcNodes.length; i++) {
                if (srcNodes[i].id.substr(0, 1) === 't' && srcNodes[i].name.indexOf('[正在维修]') < 0 && srcNodes[i].name.indexOf('[正在洒水]') < 0) {
                    nozzleNodes.push(srcNodes[i]);
                }
            }
            if (nozzleNodes.length === 0) {
                parent.alertify.error("请从左边选择合适的洒水站");
                return;
            }
            for (var j=0; j<nozzleNodes.length; j++) {
                $('#selected_nozzle').append('<a onclick="click_selected_nozzle(\'' + nozzleNodes[j].id + '\')" id="' + nozzleNodes[j].id + '" href="javascript:void(0)" class="list-group-item list-group-item-info" data-original-title="" title="" data-parent_id="' + nozzleNodes[j].parent_id + '" data-icon="' + nozzleNodes[j].icon + '">' + nozzleNodes[j].name + '</a>');
                $.fn.zTree.getZTreeObj("nozzletree").removeNode(nozzleNodes[j]);
            }
            $.fn.zTree.getZTreeObj("nozzletree").checkAllNodes(false);
            reinitIframe();
        });

        $("#to_tree").click(function() {
            if (selected_nozzle_id === '') {
                parent.alertify.error("请从右边选择一个洒水站");
                return;
            }
            var selectedElement = $("#" + selected_nozzle_id);
            var targetNodes = $.fn.zTree.getZTreeObj("nozzletree").getNodesByFilter(function(node) {
                return node.id === "" + selectedElement.data("parent_id");
            });
            $.fn.zTree.getZTreeObj("nozzletree").addNodes(targetNodes[0], {id: selectedElement.attr("id"), parent_id: targetNodes[0].id, name: selectedElement.html(), open:true, icon:selectedElement.data("icon"), iconOpen:selectedElement.data("icon"), iconClose:selectedElement.data("icon")});
            selectedElement.remove();
            selected_nozzle_id = "";
            reinitIframe();
        });

        $("#send").click(function() {
            if ($("#hour", parent.document).val() === '') {
                parent.alertify.error("灌溉时长不能为空");
                return;
            }
            if ($("#minute", parent.document).val() === '') {
                parent.alertify.error("灌溉时长不能为空");
                return;
            }
            if ($("#selected_nozzle").children("a").length === 0) {
                parent.alertify.error("请选择洒水站");
                return;
            }
            var arr = document.getElementById("selected_nozzle").childNodes;
            var nozzle_ids = [];
            for(var i=0; i<arr.length; i++){
                nozzle_ids.push(arr[i].getAttribute("id").slice(1));
            }
            $.post("/send.do", {
                nozzle_ids: JSON.stringify(nozzle_ids),
                hour: $("#hour", parent.document).val(),
                minute: $("#minute", parent.document).val()
            }, function (result) {
                if (result.success) {
                    location.reload(true);
                    parent.document.getElementById('myFrame_area').contentWindow.location.reload(true);
                } else {
                    parent.alertify.error("网络原因，发送失败");
                }
            });
        });

        $("#map").show(function () {
            var map = new BMap.Map("map", {mapType: BMAP_SATELLITE_MAP});
{@eq key=lon value=""}
            map.centerAndZoom(new BMap.Point(116.403875, 39.915168), 19);  /* 天安门 */
{:else}
            map.centerAndZoom(new BMap.Point({lon}, {lat}), 19);
{/eq}
            map.enableDragging();
            map.enableDoubleClickZoom();
            map.addControl(new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT}));
{@ne key=lon value=""}
            var marker = new BMap.Marker(new BMap.Point({lon}, {lat}), {icon: new BMap.Icon("/img/人.png", new BMap.Size(32, 32))});
            map.addOverlay(marker);
{/ne}
{#near_controlboxes}
            marker = new BMap.Marker(new BMap.Point({lon}, {lat}), {icon: new BMap.Icon("/img/点位分控箱.png", new BMap.Size(32, 32))});
            marker.setLabel(new BMap.Label("{no}：{name}", {offset: new BMap.Size(30, -10)}));
            map.addOverlay(marker);
            marker.addEventListener("click", function() {
                var controlbox_nodes = $.fn.zTree.getZTreeObj("nozzletree").getNodesByFilter(function(node) {
                    return node.id.substr(0, 1) !== 't' && node.isHidden === false;
                });
                $.fn.zTree.getZTreeObj("nozzletree").hideNodes(controlbox_nodes);
                var nodes = $.fn.zTree.getZTreeObj("nozzletree").getNodesByFilter(function(node) {
                    return node.id === "{id}";
                });
                $.fn.zTree.getZTreeObj("nozzletree").showNodes(nodes);
            });
{/near_controlboxes}

            reinitIframe();
        });
    });

    window.onresize = function () {
        reinitIframe();
    };

    function reinitIframe() {
        parent.document.getElementById('myFrame_location').height = document.body.scrollHeight || document.documentElement.scrollHeight;
    }
</script>
</body>
</html>